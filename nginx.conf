worker_processes auto;                # 워커 프로세스 개수를 CPU 코어 수에 맞게 자동 설정

events {
    worker_connections 1024;          # 각 워커 프로세스가 동시에 처리할 수 있는 연결 수 (1024개)
}

http {
    include       mime.types;         # MIME 타입 정의 파일 포함 (text/html, image/png 등)
    default_type  application/octet-stream; # 기본 MIME 타입 (알 수 없는 경우 이 타입으로 응답)

    sendfile on;                      # sendfile() 시스템 콜 사용 → 파일 전송 성능 향상
    tcp_nopush on;                    # TCP 패킷을 모아 한번에 전송 (효율적)
    tcp_nodelay on;                   # 작은 패킷도 지연 없이 즉시 전송
    keepalive_timeout 65;             # keep-alive 연결 유지 시간 (초)

    map $http_upgrade $connection_upgrade {
        default upgrade;              # HTTP Upgrade 헤더가 있으면 'upgrade'로 설정
        '' close;                     # 없으면 'close'로 설정 → WebSocket 연결에 필요
    }

    upstream nextjs {
        server 127.0.0.1:3000;        # Next.js 서버 (SSR) → 로컬 3000 포트
    }

    upstream nestjs {
        server 127.0.0.1:4000;        # NestJS 서버 (API, socket.io) → 로컬 4000 포트
    }

    server {
        listen 80;                    # HTTP (80포트) 리스닝
        server_name your-domain.com;  # 도메인 이름 지정

        # Let's Encrypt 인증서 발급 시 사용되는 경로
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;    # certbot이 challenge 파일을 저장하는 디렉토리
        }

        location / {
            return 301 https://$host$request_uri; # 모든 HTTP 요청을 HTTPS로 리다이렉트
        }
    }

    server {
        listen 443 ssl;               # HTTPS (443포트) 리스닝
        server_name your-domain.com;  # 도메인 이름 지정

        ssl_certificate     /etc/letsencrypt/live/your-domain.com/fullchain.pem; # SSL 인증서
        ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;   # SSL 개인키

        ssl_protocols TLSv1.2 TLSv1.3; # 허용할 TLS 버전
        ssl_prefer_server_ciphers on;  # 서버 우선 암호화 방식 사용

        # Next.js (SSR)
        location / {
            proxy_pass http://nextjs; # 요청을 Next.js 서버로 전달
            proxy_http_version 1.1;   # HTTP/1.1 사용 (keep-alive, WebSocket 지원)
            proxy_set_header Host $host;                     # 원래 Host 헤더 전달
            proxy_set_header X-Real-IP $remote_addr;         # 클라이언트 실제 IP 전달
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 프록시 체인 IP 전달
            proxy_set_header X-Forwarded-Proto $scheme;      # 요청 프로토콜 전달 (http/https)
        }

        # NestJS API
        location /api/ {
            proxy_pass http://nestjs; # 요청을 NestJS 서버로 전달
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket (socket.io)
        location /socket.io/ {
            proxy_pass http://nestjs; # WebSocket 요청을 NestJS 서버로 전달
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;          # WebSocket 업그레이드 헤더
            proxy_set_header Connection $connection_upgrade; # 연결 상태 헤더
            proxy_set_header Host $host;
            proxy_read_timeout 86400;                        # WebSocket 연결 유지 시간 (1일)
        }
    }
}

# 유효성 테스트: sudo nginx -t