name: CI-CD

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
  workflow_dispatch:

jobs:
  frontend:
    # paths 조건으로 이미 필터링됨
    runs-on: ubuntu-latest
    name: Build & Deploy Frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to NCP Registry
        run: |
          docker login \
            -u ${{ secrets.NCP_REGISTRY_USER }} \
            -p ${{ secrets.NCP_REGISTRY_PASSWORD }} \
            ${{ secrets.NCP_REGISTRY_URL }}

      - name: Build & Push Frontend
        run: |
          docker build -t ${{ secrets.NCP_REGISTRY_URL }}/project/frontend:latest ./frontend
          docker push ${{ secrets.NCP_REGISTRY_URL }}/project/frontend:latest

      - name: Deploy Frontend
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.APP_SERVER_HOST }}
          username: ${{ secrets.APP_SERVER_USER }}
          key: ${{ secrets.APP_SERVER_SSH_KEY }}
          script: |
            cd /home/${{ secrets.APP_SERVER_USER }}/app
            docker-compose pull frontend
            docker-compose up -d frontend

  backend:
    runs-on: ubuntu-latest
    name: Build & Deploy Backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to NCP Registry
        run: |
          docker login \
            -u ${{ secrets.NCP_REGISTRY_USER }} \
            -p ${{ secrets.NCP_REGISTRY_PASSWORD }} \
            ${{ secrets.NCP_REGISTRY_URL }}

      - name: Build & Push Backend
        run: |
          docker build -t ${{ secrets.NCP_REGISTRY_URL }}/project/backend:latest ./backend
          docker push ${{ secrets.NCP_REGISTRY_URL }}/project/backend:latest

      - name: Deploy Backend
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.APP_SERVER_HOST }}
          username: ${{ secrets.APP_SERVER_USER }}
          key: ${{ secrets.APP_SERVER_SSH_KEY }}
          script: |
            cd /home/${{ secrets.APP_SERVER_USER }}/app
            docker-compose pull backend
            docker-compose up -d backend

# CI/CD 흐름 검증

# 1. Frontend 변경 시

# frontend Docker build

# NCR push

# 서버:
# docker-compose pull frontend # 지정한 서비스의 이미지를 레지스트리에서 최신 버전으로 가져옵니다.
# docker-compose up -d frontend # 해당 서비스만 최신 이미지로 재시작합니다.

# 2. Backend 변경 시

# backend Docker build

# NCR push

# 서버:
# docker-compose pull backend
# docker-compose up -d backend

# → Nginx, 다른 서비스 재기동 없음

# docker-compose down: 모든 컨테이너를 정지하고 삭제합니다. 사용 x
