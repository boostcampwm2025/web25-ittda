name: CI/CD Pipeline - NCP Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

# TODO: 아래는 cicd 예시이고 프로젝트에 맞게 변경할 예정

jobs:
  # ========================================
  # Job 0: 프론트 & 백엔드 테스트
  # ========================================
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm" # pnpm 의존성 캐시를 활성화
      - run: corepack enable
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:all # 루트에서 프론트+백 테스트 모두 실행

  # ========================================
  # Job 1: 백엔드 이미지 빌드 및 푸시
  # ========================================
  build-and-push-backend:
    name: Build and Push Backend Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NCP Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.NCP_REGISTRY }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECRET_ACCESS_KEY }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.NCP_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
            ${{ env.NCP_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.NCP_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.NCP_REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:buildcache,mode=max

  # ========================================
  # Job 2: 프론트엔드 이미지 빌드 및 푸시
  # ========================================
  build-and-push-frontend:
    name: Build and Push Frontend Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to NCP Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.NCP_REGISTRY }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECRET_ACCESS_KEY }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.NCP_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
            ${{ env.NCP_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
          build-args: |
            VITE_API_SERVER=/api
          cache-from: type=registry,ref=${{ env.NCP_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.NCP_REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:buildcache,mode=max

  # ========================================
  # Job 3: NCP 서버에서 무중단 배포
  # ========================================
  deploy-to-ncp:
    name: Deploy to NCP Server (Zero Downtime)
    runs-on: ubuntu-latest
    needs: [build-and-push-backend, build-and-push-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_PRIVATE_KEY }}
          port: ${{ secrets.NCP_PORT }}
          source: "deploy.sh,nginx.conf"
          target: "~/web-os"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          NCP_REGISTRY: ${{ env.NCP_REGISTRY }}
          NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
          NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_ACCESS_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          HTTPS: ${{ secrets.HTTPS }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE_NAME }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE_NAME }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_PRIVATE_KEY }}
          port: ${{ secrets.NCP_PORT }}
          envs: NCP_REGISTRY,NCP_ACCESS_KEY,NCP_SECRET_KEY,SESSION_SECRET,FRONTEND_URL,HTTPS,BACKEND_IMAGE,FRONTEND_IMAGE,COMMIT_SHA
          script_stop: true
          script: |
            # 작업 디렉토리 생성 및 이동
            mkdir -p ~/web-os
            cd ~/web-os

            # 환경 변수 파일 생성 (매 배포마다 새로 생성)
            echo "SESSION_SECRET=$SESSION_SECRET" > .env
            echo "FRONTEND_URL=$FRONTEND_URL" >> .env
            echo "HTTPS=$HTTPS" >> .env

            # deploy.sh 실행 권한 부여
            chmod +x deploy.sh

            # Docker Registry 로그인
            echo "$NCP_SECRET_KEY" | docker login $NCP_REGISTRY -u $NCP_ACCESS_KEY --password-stdin

            # 새 이미지 Pull
            docker pull $NCP_REGISTRY/$BACKEND_IMAGE:$COMMIT_SHA
            docker pull $NCP_REGISTRY/$FRONTEND_IMAGE:$COMMIT_SHA

            # 환경 변수 설정 및 무중단 배포 실행
            export NCP_CONTAINER_REGISTRY=$NCP_REGISTRY
            export FRONTEND_URL=$FRONTEND_URL
            export HTTPS=$HTTPS
            ./deploy.sh $COMMIT_SHA

            # 사용하지 않는 이미지 정리
            docker image prune -af --filter "until=24h"

            echo "✅ Deployment completed successfully!"
